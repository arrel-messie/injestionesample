{
  "type": "kafka",
  "spec": {
    "ioConfig": {
      "type": "kafka",
      "consumerProperties": {
        "bootstrap.servers": "${KAFKA_BOOTSTRAP_SERVERS}",
        "security.protocol": "SASL_SSL",
        "sasl.mechanism": "PLAIN",
        "sasl.jaas.config": "${KAFKA_SASL_JAAS_CONFIG}",
        "ssl.endpoint.identification.algorithm": "https",
        "group.id": "druid-${DATASOURCE_NAME}-${ENVIRONMENT}",
        "fetch.min.bytes": ${KAFKA_FETCH_MIN_BYTES:-1048576},
        "fetch.max.wait.ms": ${KAFKA_FETCH_MAX_WAIT_MS:-500},
        "max.poll.records": ${KAFKA_MAX_POLL_RECORDS:-500},
        "session.timeout.ms": ${KAFKA_SESSION_TIMEOUT_MS:-30000},
        "heartbeat.interval.ms": ${KAFKA_HEARTBEAT_INTERVAL_MS:-3000},
        "max.poll.interval.ms": ${KAFKA_MAX_POLL_INTERVAL_MS:-300000},
        "enable.auto.commit": false
      },
      "topic": "${KAFKA_TOPIC}",
      "inputFormat": {
        "type": "protobuf",
        "protoBytesDecoder": {
          "type": "file",
          "descriptorFilePath": "s3://${S3_BUCKET}/schemas/${SCHEMA_VERSION}/${PROTO_DESCRIPTOR_FILE}",
          "protoMessageType": "${PROTO_MESSAGE_TYPE}"
        }
      },
      "useEarliestOffset": ${USE_EARLIEST_OFFSET:-false},
      "useTransaction": ${USE_TRANSACTION:-true},
      "taskCount": ${TASK_COUNT:-10},
      "replicas": ${REPLICAS:-2},
      "taskDuration": "${TASK_DURATION:-PT1H}",
      "startDelay": "${START_DELAY:-PT5S}",
      "period": "${PERIOD:-PT30S}",
      "completionTimeout": "${COMPLETION_TIMEOUT:-PT1H}",
      "lateMessageRejectionPeriod": "${LATE_MESSAGE_REJECTION_PERIOD:-PT1H}",
      "pollTimeout": ${POLL_TIMEOUT:-100},
      "minimumMessageTime": "${MINIMUM_MESSAGE_TIME:-1970-01-01T00:00:00.000Z}"
    },
    "tuningConfig": {
      "type": "kafka",
      "maxRowsInMemory": ${MAX_ROWS_IN_MEMORY:-500000},
      "maxBytesInMemory": ${MAX_BYTES_IN_MEMORY:-536870912},
      "maxRowsPerSegment": ${MAX_ROWS_PER_SEGMENT:-5000000},
      "maxTotalRows": null,
      "intermediatePersistPeriod": "${INTERMEDIATE_PERSIST_PERIOD:-PT10M}",
      "maxPendingPersists": ${MAX_PENDING_PERSISTS:-2},
      "indexSpec": {
        "bitmap": {
          "type": "roaring"
        },
        "dimensionCompression": "lz4",
        "metricCompression": "lz4",
        "longEncoding": "longs"
      },
      "indexSpecForIntermediatePersists": {
        "bitmap": {
          "type": "roaring"
        },
        "dimensionCompression": "lz4",
        "metricCompression": "lz4",
        "longEncoding": "longs"
      },
      "reportParseExceptions": ${REPORT_PARSE_EXCEPTIONS:-true},
      "handoffConditionTimeout": ${HANDOFF_CONDITION_TIMEOUT:-900000},
      "resetOffsetAutomatically": ${RESET_OFFSET_AUTOMATICALLY:-false},
      "workerThreads": null,
      "chatThreads": null,
      "chatRetries": ${CHAT_RETRIES:-8},
      "httpTimeout": "${HTTP_TIMEOUT:-PT10S}",
      "shutdownTimeout": "${SHUTDOWN_TIMEOUT:-PT80S}",
      "offsetFetchPeriod": "${OFFSET_FETCH_PERIOD:-PT30S}",
      "intermediateHandoffPeriod": "${INTERMEDIATE_HANDOFF_PERIOD:-P2147483647D}",
      "logParseExceptions": ${LOG_PARSE_EXCEPTIONS:-true},
      "maxParseExceptions": ${MAX_PARSE_EXCEPTIONS:-10000},
      "maxSavedParseExceptions": ${MAX_SAVED_PARSE_EXCEPTIONS:-100},
      "skipSequenceNumberAvailabilityCheck": ${SKIP_SEQUENCE_NUMBER_AVAILABILITY_CHECK:-false},
      "partitionsSpec": {
        "type": "${PARTITIONS_SPEC_TYPE:-dynamic}"
      },
      "splitHintSpec": {
        "type": "maxSize",
        "maxSplitSize": ${MAX_SPLIT_SIZE:-1073741824},
        "maxInputSegmentBytesPerTask": ${MAX_INPUT_SEGMENT_BYTES_PER_TASK:-10737418240}
      }
    },
    "dataSchema": {
      "dataSource": "${DATASOURCE_NAME}",
      "timestampSpec": {
        "column": "${TIMESTAMP_COLUMN}",
        "format": "${TIMESTAMP_FORMAT:-auto}",
        "missingValue": null
      },
      "transformSpec": {
        "transforms": [],
        "filter": null
      },
      "dimensionsSpec": {
        "dimensions": ${DIMENSIONS_JSON},
        "dimensionExclusions": [],
        "includeAllDimensions": false,
        "useSchemaDiscovery": false
      },
      "metricsSpec": [
        {
          "type": "count",
          "name": "count"
        }
      ],
      "granularitySpec": {
        "type": "uniform",
        "segmentGranularity": "${SEGMENT_GRANULARITY:-DAY}",
        "queryGranularity": "${QUERY_GRANULARITY:-NONE}",
        "rollup": ${ROLLUP:-false},
        "intervals": null
      }
    }
  }
}
