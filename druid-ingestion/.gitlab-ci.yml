stages:
  - build
  - deploy

variables:
  PROTO_MESSAGE_TYPE: "com.company.PaymentTransactionEvent"
  PROTO_FILE: "schemas/proto/settlement_transaction.proto"
  PROTO_DESC_OUTPUT: "schemas/compiled/settlement_transaction.desc"

build:
  stage: build
  image: alpine:latest
  before_script:
    - apk add --no-cache bash protobuf
    - chmod +x druid-ingestion.sh
  script:
    - mkdir -p schemas/compiled
    - protoc --descriptor_set_out="${PROTO_DESC_OUTPUT}" --include_imports --proto_path=schemas/proto "${PROTO_FILE}"
    - ./druid-ingestion.sh build -e dev
  artifacts:
    paths:
      - schemas/compiled/*.desc
      - druid-specs/generated/*.json
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests

deploy:dev:
  stage: deploy
  dependencies:
    - build
  before_script:
    - test -f config/dev.env || exit 1
    - |
      if [ -n "${DRUID_URL_DEV}" ]; then
        sed -i '' "s|^DRUID_URL=.*|DRUID_URL=${DRUID_URL_DEV}|" config/dev.env
      else
        sed -i '' 's|^DRUID_URL=.*|DRUID_URL="http://coordinator:8081"|' config/dev.env
      fi
  script:
    # Copie directe dans le volume (shell executor a accès au Docker de l'hôte)
    - |
      VOLUME_NAME=$(docker volume ls --format "{{.Name}}" | grep druid_shared | head -1)
      if [ -n "$VOLUME_NAME" ]; then
        docker run --rm \
          --network druid-infra_default \
          -v "$VOLUME_NAME:/opt/shared" \
          -v $(pwd)/schemas/compiled:/source:ro \
          alpine:latest sh -c "mkdir -p /opt/shared/schemas && cp /source/*.desc /opt/shared/schemas/"
      else
        echo "ERROR: druid_shared volume not found"
        exit 1
      fi
    # Déploiement via le réseau Compose
    - |
      source config/dev.env
      docker run --rm \
        --network druid-infra_default \
        -v $(pwd):/workspace \
        -w /workspace \
        -e DRUID_URL \
        alpine:latest sh -c "
          apk add --no-cache bash curl jq gettext
          chmod +x druid-ingestion.sh
          ./druid-ingestion.sh deploy -e dev
        "
  only:
    - main
    - develop
  when: manual
  tags:
    - shell  # ← Nouveau tag
